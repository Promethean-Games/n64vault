 border-box; }
    html, body {
      width: 100%;
      height: 100%;
      overflow: hidden;
    }
    body {
      background: #000;
      color: #fff;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }
    #container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
    }
    #display {
      background: #000;
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    #status {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      color: #E43F5A;
      font-size: 14px;
      background: rgba(0,0,0,0.8);
      padding: 8px 16px;
      border-radius: 4px;
    }
    #controls {
      position: absolute;
      bottom: 60px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 10px;
    }
    button {
      background: #E43F5A;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }
    button:hover {
      background: #E94560;
    }
    button:disabled {
      background: #444;
      cursor: not-allowed;
    }
    #file-input {
      display: none;
    }
    .hidden { display: none !important; }
    .standalone-only { display: flex; }
    body.in-iframe .standalone-only { display: none !important; }
    body.in-iframe #status { display: none; }
    #alerts { position: fixed; top: 10px; left: 10px; right: 10px; z-index: 1000; }
    #performance { 
      position: fixed; 
      top: 10px; 
      right: 10px; 
      font-size: 11px; 
      color: #aaa;
      background: rgba(0,0,0,0.7);
      padding: 5px 10px;
      border-radius: 4px;
    }
    .debug-adjacent { display: none; }
    #info { display: none; }
  </style>
</head>
<body>
  <div id="alerts"></div>
  
  <div id="container">
    <canvas id="display" width="640" height="480"></canvas>
    <div id="adjacent-debug" class="debug debug-adjacent hidden"></div>
    <div id="performance"></div>
    <div id="status">Initializing emulator...</div>
    <div id="controls" class="standalone-only">
      <button id="btn-load">Load ROM</button>
      <button id="btn-run" disabled>Run</button>
      <button id="btn-fullscreen">Fullscreen</button>
    </div>
    <input type="file" id="file-input" accept=".z64,.n64,.v64,.rom">
  </div>
  
  <div id="info" style="display:none"></div>

  <script type="importmap">
  {
    "imports": {
      "n64js": "./n64.min.js"
    }
  }
  </script>
  
  <script type="module">
    import * as n64jsModule from 'n64js';
    
    const isEmbedded = window.parent !== window;
    const parentOrigin = window.location.origin;
    let emulatorReady = false;
    let isRunning = false;
    let hasWebGL = false;
    
    function notifyParent(message) {
      if (isEmbedded && window.parent) {
        try {
          window.parent.postMessage(message, parentOrigin);
        } catch (e) {
          console.error('Failed to post message to parent:', e);
        }
      }
    }
    
    function updateStatus(text) {
      const statusEl = document.getElementById('status');
      if (statusEl) statusEl.textContent = text;
    }
    
    function setEmulatorState(state, errorMsg = null) {
      notifyParent({ type: 'stateChange', state, error: errorMsg });
      if (state === 'running') {
        isRunning = true;
        updateStatus('Running');
      } else if (state === 'paused') {
        isRunning = false;
        updateStatus('Paused');
      } else if (state === 'error') {
        isRunning = false;
        updateStatus('Error: ' + (errorMsg || 'Unknown error'));
        notifyParent({ type: 'error', message: errorMsg || 'Unknown error' });
      }
    }
    
    function checkWebGLSupport() {
      try {
        const canvas = document.createElement('canvas');
        const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
        hasWebGL = !!gl;
        return hasWebGL;
      } catch (e) {
        hasWebGL = false;
        return false;
      }
    }
    
    if (isEmbedded) {
      document.body.classList.add('in-iframe');
    }
    
    function initEmulator() {
      if (!checkWebGLSupport()) {
        setEmulatorState('error', 'WebGL is not supported in your browser. N64 emulation requires WebGL.');
        notifyParent({ type: 'unsupported', reason: 'webgl' });
        return false;
      }
      
      try {
        if (window.n64js && window.n64js.init) {
          window.n64js.init();
          emulatorReady = true;
          updateStatus('Ready - Load a ROM to start');
          notifyParent({ type: 'emulatorReady' });
          console.log('n64js initialized and ready');
          
          document.getElementById('display').focus();
          
          return true;
        } else {
          throw new Error('n64js API not available');
        }
      } catch (error) {
        console.error('Failed to initialize n64js:', error);
        setEmulatorState('error', 'Failed to initialize emulator: ' + error.message);
        return false;
      }
    }
    
    window.addEventListener('DOMContentLoaded', () => {
      const btnLoad = document.getElementById('btn-load');
      const btnRun = document.getElementById('btn-run');
      const btnFullscreen = document.getElementById('btn-fullscreen');
      const fileInput = document.getElementById('file-input');
      
      if (btnLoad) {
        btnLoad.onclick = () => fileInput?.click();
      }
      
      if (btnRun) {
        btnRun.onclick = () => window.toggleRun();
      }
      
      if (btnFullscreen) {
        btnFullscreen.onclick = () => window.goFullscreen();
      }
      
      if (fileInput) {
        fileInput.onchange = (event) => window.handleFileSelect(event);
      }
      
      setTimeout(() => {
        initEmulator();
      }, 100);
    });
    
    window.toggleRun = function() {
      if (!emulatorReady) return;
      
      try {
        if (window.n64js && window.n64js.toggleRun) {
          window.n64js.toggleRun();
          isRunning = !isRunning;
          setEmulatorState(isRunning ? 'running' : 'paused');
        }
      } catch (error) {
        console.error('Toggle run failed:', error);
        setEmulatorState('error', 'Failed to toggle run: ' + error.message);
      }
    };
    
    window.goFullscreen = function() {
      try {
        if (window.n64js && window.n64js.toggleFullscreen) {
          window.n64js.toggleFullscreen();
        } else {
          const canvas = document.getElementById('display');
          if (canvas && canvas.requestFullscreen) {
            canvas.requestFullscreen();
          }
        }
      } catch (error) {
        console.error('Fullscreen failed:', error);
      }
    };
    
    window.resetEmulator = function() {
      try {
        if (window.n64js && window.n64js.reset) {
          window.n64js.reset();
          isRunning = true;
          setEmulatorState('running');
        }
      } catch (error) {
        console.error('Reset failed:', error);
        setEmulatorState('error', 'Failed to reset: ' + error.message);
      }
    };
    
    window.loadRom = function(arrayBuffer, romName) {
      if (!emulatorReady) {
        if (!initEmulator()) {
          setEmulatorState('error', 'Emulator not ready and failed to initialize');
          return;
        }
      }
      
      updateStatus('Loading ROM...');
      notifyParent({ type: 'stateChange', state: 'loading-rom' });
      
      try {
        if (window.n64js && window.n64js.loadRomAndStartRunning) {
          window.n64js.loadRomAndStartRunning(arrayBuffer);
          const btnRun = document.getElementById('btn-run');
          if (btnRun) btnRun.disabled = false;
          isRunning = true;
          updateStatus('Running - ' + (romName || 'Unknown ROM'));
          setEmulatorState('running');
          
          document.getElementById('display')?.focus();
        } else {
          throw new Error('loadRomAndStartRunning not available');
        }
      } catch (error) {
        console.error('Failed to load ROM:', error);
        setEmulatorState('error', 'Failed to load ROM: ' + error.message);
      }
    };
    
    window.handleFileSelect = function(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      updateStatus('Loading ROM...');
      
      const reader = new FileReader();
      reader.onload = function(e) {
        window.loadRom(e.target.result, file.name);
      };
      reader.onerror = function() {
        setEmulatorState('error', 'Failed to read ROM file');
      };
      reader.readAsArrayBuffer(file);
    };
    
    window.addEventListener('message', function(event) {
      if (event.origin !== parentOrigin && event.origin !== window.location.origin) {
        console.warn('Ignoring message from unknown origin:', event.origin);
        return;
      }
      
      const data = event.data;
      
      if (data.type === 'loadRom') {
        const romData = data.romData;
        const romName = data.romName;
        window.loadRom(romData, romName);
      } else if (data.type === 'toggleRun') {
        window.toggleRun();
      } else if (data.type === 'reset') {
        window.resetEmulator();
      } else if (data.type === 'fullscreen') {
        window.goFullscreen();
      } else if (data.type === 'focus') {
        document.getElementById('display')?.focus();
      } else if (data.type === 'ping') {
        notifyParent({ type: 'pong', ready: emulatorReady, running: isRunning, hasWebGL });
      }
    });
    
    setTimeout(() => {
      notifyParent({ type: 'iframeLoaded' });
    }, 100);
    
    window.addEventListener('click', () => {
      document.getElementById('display')?.focus();
    });
    
    window.addEventListener('focus', () => {
      document.getElementById('display')?.focus();
    });
  </script>
</body>
</html>
